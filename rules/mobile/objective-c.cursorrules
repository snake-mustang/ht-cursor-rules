---
description: "Objective-C iOS 开发最佳实践"
globs:
  - "**/*.h"
  - "**/*.m"
alwaysApply: false
---

# Objective-C iOS 开发规则

你是 Objective-C iOS 开发专家，精通 UIKit、Foundation 框架、内存管理，编写高质量、符合 Apple 规范的 iOS 应用。

## 核心原则

### 1. 命名规范
- **类名**：使用前缀 + PascalCase（如 `MyAppViewController`, `MyAppDataManager`）
- **方法名**：使用 camelCase，动词开头（如 `loadUserData`, `saveToDatabase`）
- **属性**：使用 camelCase（如 `userName`, `isLoggedIn`）
- **常量**：使用 k 前缀 + PascalCase（如 `kMaxRetryCount`）
- **枚举**：使用 NS_ENUM 或 NS_OPTIONS

### 2. 文件组织
```
ProjectName/
├── AppDelegate.h/m
├── Controllers/
│   ├── ViewControllers/
│   └── NavigationControllers/
├── Views/
│   ├── CustomViews/
│   └── Cells/
├── Models/
├── Services/
├── Utilities/
├── Resources/
│   ├── Images.xcassets
│   └── Storyboards/
└── Supporting Files/
```

## 类声明

### 头文件（.h）

```objectivec
//
//  MyViewController.h
//  MyApp
//
//  Created by Developer on 2024/01/01.
//  Copyright © 2024 MyCompany. All rights reserved.
//

#import <UIKit/UIKit.h>

NS_ASSUME_NONNULL_BEGIN

// 前向声明
@class User;
@protocol MyViewControllerDelegate;

/**
 * 用户信息展示控制器
 * 负责展示和编辑用户信息
 */
@interface MyViewController : UIViewController

// MARK: - Properties

/**
 * 用户数据模型
 */
@property (nonatomic, strong) User *user;

/**
 * 代理对象
 */
@property (nonatomic, weak, nullable) id<MyViewControllerDelegate> delegate;

/**
 * 是否处于编辑模式
 */
@property (nonatomic, assign, getter=isEditing) BOOL editing;

// MARK: - Initialization

/**
 * 指定初始化方法
 * @param user 用户对象
 * @return 初始化的视图控制器实例
 */
- (instancetype)initWithUser:(User *)user NS_DESIGNATED_INITIALIZER;

// MARK: - Public Methods

/**
 * 刷新用户数据
 */
- (void)refreshUserData;

/**
 * 保存更改
 * @param completion 完成回调
 */
- (void)saveChangesWithCompletion:(void (^)(BOOL success, NSError * _Nullable error))completion;

@end

// MARK: - Delegate Protocol

/**
 * 视图控制器代理协议
 */
@protocol MyViewControllerDelegate <NSObject>

@required
/**
 * 用户信息更新时调用
 * @param controller 控制器实例
 * @param user 更新后的用户对象
 */
- (void)myViewController:(MyViewController *)controller didUpdateUser:(User *)user;

@optional
/**
 * 用户信息更新失败时调用
 * @param controller 控制器实例
 * @param error 错误对象
 */
- (void)myViewController:(MyViewController *)controller didFailWithError:(NSError *)error;

@end

NS_ASSUME_NONNULL_END
```

### 实现文件（.m）

```objectivec
//
//  MyViewController.m
//  MyApp
//
//  Created by Developer on 2024/01/01.
//  Copyright © 2024 MyCompany. All rights reserved.
//

#import "MyViewController.h"
#import "User.h"

// 私有常量
static const CGFloat kPadding = 16.0;
static NSString * const kUserDefaultsKey = @"com.myapp.userdata";

// 私有接口（类扩展）
@interface MyViewController () <UITableViewDelegate, UITableViewDataSource>

// 私有属性
@property (nonatomic, strong) UITableView *tableView;
@property (nonatomic, strong) NSArray<NSString *> *dataSource;
@property (nonatomic, assign) BOOL isLoading;

@end

@implementation MyViewController

// MARK: - Lifecycle

- (instancetype)initWithUser:(User *)user {
    self = [super initWithNibName:nil bundle:nil];
    if (self) {
        _user = user;
        _editing = NO;
    }
    return self;
}

- (instancetype)initWithNibName:(nullable NSString *)nibNameOrNil 
                         bundle:(nullable NSBundle *)nibBundleOrNil {
    // 重定向到指定初始化方法
    return [self initWithUser:nil];
}

- (void)viewDidLoad {
    [super viewDidLoad];
    
    [self setupUI];
    [self setupConstraints];
    [self loadData];
}

- (void)viewWillAppear:(BOOL)animated {
    [super viewWillAppear:animated];
    
    [self refreshUserData];
}

- (void)viewDidAppear:(BOOL)animated {
    [super viewDidAppear:animated];
}

- (void)viewWillDisappear:(BOOL)animated {
    [super viewWillDisappear:animated];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    
    // 清理缓存数据
    [self clearCache];
}

// MARK: - Setup

- (void)setupUI {
    self.view.backgroundColor = [UIColor whiteColor];
    self.title = @"用户信息";
    
    // 创建 TableView
    self.tableView = [[UITableView alloc] initWithFrame:CGRectZero 
                                                  style:UITableViewStylePlain];
    self.tableView.delegate = self;
    self.tableView.dataSource = self;
    self.tableView.rowHeight = 60.0;
    [self.view addSubview:self.tableView];
    
    // 添加导航栏按钮
    UIBarButtonItem *editButton = [[UIBarButtonItem alloc] 
                                   initWithBarButtonSystemItem:UIBarButtonSystemItemEdit
                                   target:self
                                   action:@selector(editButtonTapped:)];
    self.navigationItem.rightBarButtonItem = editButton;
}

- (void)setupConstraints {
    self.tableView.translatesAutoresizingMaskIntoConstraints = NO;
    
    [NSLayoutConstraint activateConstraints:@[
        [self.tableView.topAnchor constraintEqualToAnchor:self.view.safeAreaLayoutGuide.topAnchor],
        [self.tableView.leadingAnchor constraintEqualToAnchor:self.view.leadingAnchor],
        [self.tableView.trailingAnchor constraintEqualToAnchor:self.view.trailingAnchor],
        [self.tableView.bottomAnchor constraintEqualToAnchor:self.view.safeAreaLayoutGuide.bottomAnchor]
    ]];
}

// MARK: - Data Loading

- (void)loadData {
    self.isLoading = YES;
    
    // 模拟异步加载
    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
        // 执行耗时操作
        NSArray *data = [self fetchDataFromServer];
        
        dispatch_async(dispatch_get_main_queue(), ^{
            self.dataSource = data;
            self.isLoading = NO;
            [self.tableView reloadData];
        });
    });
}

- (NSArray<NSString *> *)fetchDataFromServer {
    // 模拟数据获取
    return @[@"Item 1", @"Item 2", @"Item 3"];
}

// MARK: - Public Methods

- (void)refreshUserData {
    if (!self.user) {
        return;
    }
    
    // 刷新数据
    [self loadData];
}

- (void)saveChangesWithCompletion:(void (^)(BOOL, NSError * _Nullable))completion {
    // 验证数据
    if (![self validateUserData]) {
        NSError *error = [NSError errorWithDomain:@"com.myapp.error"
                                             code:400
                                         userInfo:@{NSLocalizedDescriptionKey: @"Invalid user data"}];
        if (completion) {
            completion(NO, error);
        }
        return;
    }
    
    // 保存数据
    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
        BOOL success = [self saveToDatabase];
        
        dispatch_async(dispatch_get_main_queue(), ^{
            if (success) {
                if ([self.delegate respondsToSelector:@selector(myViewController:didUpdateUser:)]) {
                    [self.delegate myViewController:self didUpdateUser:self.user];
                }
            } else {
                NSError *error = [NSError errorWithDomain:@"com.myapp.error"
                                                     code:500
                                                 userInfo:@{NSLocalizedDescriptionKey: @"Save failed"}];
                if ([self.delegate respondsToSelector:@selector(myViewController:didFailWithError:)]) {
                    [self.delegate myViewController:self didFailWithError:error];
                }
            }
            
            if (completion) {
                completion(success, success ? nil : [NSError errorWithDomain:@"" code:0 userInfo:nil]);
            }
        });
    });
}

// MARK: - Private Methods

- (BOOL)validateUserData {
    return self.user && self.user.name.length > 0;
}

- (BOOL)saveToDatabase {
    // 模拟保存操作
    [NSThread sleepForTimeInterval:1.0];
    return YES;
}

- (void)clearCache {
    self.dataSource = nil;
}

// MARK: - Actions

- (void)editButtonTapped:(UIBarButtonItem *)sender {
    self.editing = !self.isEditing;
    
    if (self.isEditing) {
        sender.title = @"完成";
    } else {
        sender.title = @"编辑";
        [self saveChangesWithCompletion:nil];
    }
}

// MARK: - UITableViewDataSource

- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView {
    return 1;
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section {
    return self.dataSource.count;
}

- (UITableViewCell *)tableView:(UITableView *)tableView 
         cellForRowAtIndexPath:(NSIndexPath *)indexPath {
    static NSString *cellIdentifier = @"Cell";
    
    UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:cellIdentifier];
    if (!cell) {
        cell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleDefault 
                                      reuseIdentifier:cellIdentifier];
    }
    
    cell.textLabel.text = self.dataSource[indexPath.row];
    
    return cell;
}

// MARK: - UITableViewDelegate

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath {
    [tableView deselectRowAtIndexPath:indexPath animated:YES];
    
    NSString *selectedItem = self.dataSource[indexPath.row];
    NSLog(@"Selected: %@", selectedItem);
}

// MARK: - Dealloc

- (void)dealloc {
    // 清理工作
    [[NSNotificationCenter defaultCenter] removeObserver:self];
}

@end
```

## 属性声明

```objectivec
// 强引用（默认）
@property (nonatomic, strong) NSString *name;
@property (nonatomic, strong) UIView *customView;

// 弱引用（避免循环引用）
@property (nonatomic, weak) id<MyDelegate> delegate;
@property (nonatomic, weak) IBOutlet UILabel *label;

// 复制（用于可变对象）
@property (nonatomic, copy) NSString *title;
@property (nonatomic, copy) NSArray *items;
@property (nonatomic, copy) void (^completionHandler)(BOOL success);

// 赋值（基本类型）
@property (nonatomic, assign) NSInteger count;
@property (nonatomic, assign) BOOL isEnabled;
@property (nonatomic, assign) CGFloat height;

// 只读属性
@property (nonatomic, readonly) NSString *identifier;

// 可读写属性（在类扩展中重新声明为 readwrite）
// .h
@property (nonatomic, readonly) NSString *status;
// .m 类扩展
@property (nonatomic, readwrite) NSString *status;

// Getter 方法自定义名称
@property (nonatomic, assign, getter=isLoading) BOOL loading;
```

## 内存管理（ARC）

```objectivec
// ✅ 避免循环引用
@interface MyViewController ()
@property (nonatomic, strong) MyNetworkManager *networkManager;
@end

@implementation MyViewController

- (void)fetchData {
    __weak typeof(self) weakSelf = self;
    [self.networkManager fetchDataWithCompletion:^(NSData *data, NSError *error) {
        __strong typeof(weakSelf) strongSelf = weakSelf;
        if (!strongSelf) return;
        
        // 使用 strongSelf
        [strongSelf processData:data];
    }];
}

@end

// ✅ Block 属性使用 copy
@property (nonatomic, copy) void (^completionHandler)(void);

// ✅ Delegate 使用 weak
@property (nonatomic, weak) id<MyDelegate> delegate;
```

## 枚举和常量

```objectivec
// 枚举
typedef NS_ENUM(NSInteger, UserStatus) {
    UserStatusActive,
    UserStatusInactive,
    UserStatusBanned
};

typedef NS_OPTIONS(NSUInteger, ViewOptions) {
    ViewOptionNone      = 0,
    ViewOptionRounded   = 1 << 0,
    ViewOptionShadow    = 1 << 1,
    ViewOptionBorder    = 1 << 2
};

// 字符串常量
extern NSString * const MyAppErrorDomain;
extern NSString * const MyAppNotificationName;

// .m 文件
NSString * const MyAppErrorDomain = @"com.myapp.error";
NSString * const MyAppNotificationName = @"MyAppNotification";

// 静态常量
static const NSTimeInterval kAnimationDuration = 0.3;
static const CGFloat kCornerRadius = 8.0;
```

## Block 使用

```objectivec
// Block 定义
typedef void (^CompletionBlock)(BOOL success, NSError *error);
typedef NSString * (^StringBlock)(NSString *input);

// Block 属性
@property (nonatomic, copy) CompletionBlock completionHandler;

// Block 参数
- (void)fetchDataWithCompletion:(CompletionBlock)completion {
    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
        // 执行操作
        BOOL success = YES;
        
        dispatch_async(dispatch_get_main_queue(), ^{
            if (completion) {
                completion(success, nil);
            }
        });
    });
}

// 使用 Block
[self fetchDataWithCompletion:^(BOOL success, NSError *error) {
    if (success) {
        NSLog(@"Success");
    } else {
        NSLog(@"Error: %@", error);
    }
}];
```

## 通知

```objectivec
// 注册通知
[[NSNotificationCenter defaultCenter] addObserver:self
                                         selector:@selector(handleNotification:)
                                             name:UIApplicationDidBecomeActiveNotification
                                           object:nil];

// 处理通知
- (void)handleNotification:(NSNotification *)notification {
    NSDictionary *userInfo = notification.userInfo;
    // 处理通知
}

// 发送通知
[[NSNotificationCenter defaultCenter] postNotificationName:MyAppNotificationName
                                                    object:self
                                                  userInfo:@{@"key": @"value"}];

// 移除通知（在 dealloc 中）
- (void)dealloc {
    [[NSNotificationCenter defaultCenter] removeObserver:self];
}
```

## KVO（键值观察）

```objectivec
// 添加观察者
[self.user addObserver:self
            forKeyPath:@"name"
               options:NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld
               context:NULL];

// 观察回调
- (void)observeValueForKeyPath:(NSString *)keyPath
                      ofObject:(id)object
                        change:(NSDictionary<NSKeyValueChangeKey,id> *)change
                       context:(void *)context {
    if ([keyPath isEqualToString:@"name"]) {
        NSString *oldValue = change[NSKeyValueChangeOldKey];
        NSString *newValue = change[NSKeyValueChangeNewKey];
        NSLog(@"Name changed from %@ to %@", oldValue, newValue);
    }
}

// 移除观察者
- (void)dealloc {
    [self.user removeObserver:self forKeyPath:@"name"];
}
```

## GCD（多线程）

```objectivec
// 主线程
dispatch_async(dispatch_get_main_queue(), ^{
    // 更新 UI
    self.label.text = @"Updated";
});

// 后台线程
dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
    // 执行耗时操作
    NSData *data = [self processLargeData];
    
    // 回到主线程更新 UI
    dispatch_async(dispatch_get_main_queue(), ^{
        [self updateUIWithData:data];
    });
});

// 延迟执行
dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2.0 * NSEC_PER_SEC)), 
               dispatch_get_main_queue(), ^{
    // 2 秒后执行
});

// 一次性执行
+ (instancetype)sharedInstance {
    static MyManager *instance = nil;
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken, ^{
        instance = [[self alloc] init];
    });
    return instance;
}
```

## 错误处理

```objectivec
- (BOOL)saveData:(NSData *)data error:(NSError **)error {
    if (!data) {
        if (error) {
            *error = [NSError errorWithDomain:MyAppErrorDomain
                                         code:400
                                     userInfo:@{NSLocalizedDescriptionKey: @"Data is nil"}];
        }
        return NO;
    }
    
    // 保存操作
    BOOL success = [data writeToFile:@"path" atomically:YES];
    
    if (!success && error) {
        *error = [NSError errorWithDomain:MyAppErrorDomain
                                     code:500
                                 userInfo:@{NSLocalizedDescriptionKey: @"Write failed"}];
    }
    
    return success;
}

// 使用
NSError *error = nil;
BOOL success = [self saveData:data error:&error];
if (!success) {
    NSLog(@"Error: %@", error.localizedDescription);
}
```

## 代码审查清单

- [ ] 是否正确使用 strong/weak/copy 属性修饰符
- [ ] Delegate 是否使用 weak 避免循环引用
- [ ] Block 是否使用 __weak 和 __strong 避免循环引用
- [ ] 是否在 dealloc 中移除观察者和通知
- [ ] 是否使用 NS_DESIGNATED_INITIALIZER 标记指定初始化方法
- [ ] 是否使用 nullable/nonnull 标注可空性
- [ ] 是否正确使用 GCD 进行多线程操作
- [ ] UI 更新是否在主线程执行
- [ ] 是否遵循命名规范
- [ ] 是否添加了适当的注释

遵循这些规则，可以编写出高质量的 Objective-C iOS 应用。

